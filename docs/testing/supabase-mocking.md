# Supabase Mocking Strategy

To facilitate unit and integration testing without relying on a live Supabase instance, we use a mock Supabase client.

## Mock Helper: `createMockSupabase`

A reusable helper function is available at `tests/__utils__/mockSupabase.ts`:

```typescript
import { createMockSupabase } from '@/tests/__utils__/mockSupabase';
import { Database } from '@/types/supabase'; // Assumes types generated

const mockClient = createMockSupabase<Database>();
```

This function returns a Jest mock object mimicking the `SupabaseClient` interface.

### Features:

- **Type Safety:** It uses the generated `Database` types (from `types/supabase.d.ts`) for better type checking in tests.
- **Fluent Interface Stubbing:** Methods like `select`, `insert`, `upsert`, `update`, `delete`, `eq`, `in`, `like`, etc., return chainable Jest mocks by default. This allows testing code that uses chained Supabase calls.
- **Default Promise Resolution:** Methods expected to return Promises (e.g., `single`, `maybeSingle`, `rpc`) are stubbed to return a resolved Promise with empty data and no error by default.

### Usage:

1.  **Import:** Import the helper in your test file.
2.  **Instantiate:** Create an instance `const mockSupabase = createMockSupabase<Database>();`.
3.  **Mock Injection:** Use `jest.mock` to mock the module that provides the Supabase client (e.g., `@/lib/supabase/admin` or `@/lib/supabase/client`) and make it return your `mockSupabase` instance.

    ```typescript
    jest.mock('@/lib/supabase/admin', () => ({
      createAdminClient: jest.fn(() => mockSupabase),
    }));
    ```

4.  **Override Specific Methods:** For tests that need to assert on specific Supabase calls or require specific return values/errors, mock the implementation of the relevant chained methods:

    ```typescript
    // Example: Mocking a specific select().eq() call
    const mockEq = jest.fn().mockResolvedValue({ data: [{ id: 1, name: 'Test' }], error: null });
    const mockSelect = jest.fn().mockReturnThis(); // select() is chainable

    jest.mocked(mockSupabase.from).mockReturnValue({
      ...createMockSupabase<Database>().from('your_table'), // Start with default chainable mocks
      select: mockSelect,
      eq: mockEq,
    });

    // In your test...
    await someFunctionThatUsesSupabase();

    expect(mockSupabase.from).toHaveBeenCalledWith('your_table');
    expect(mockSelect).toHaveBeenCalledWith('id, name');
    expect(mockEq).toHaveBeenCalledWith('id', 1);
    ```

### Important Notes:

- **Generated Types:** This mock relies heavily on the `Database` types generated by `supabase gen types`. Ensure `types/supabase.d.ts` is up-to-date.
- **Promise Methods:** Remember to explicitly mock the return values (using `mockResolvedValue`, `mockRejectedValue`, etc.) for methods like `single`, `maybeSingle`, `rpc`, `insert`, `upsert`, `update`, `delete` within your specific tests, as the default mock only provides a basic success case.
