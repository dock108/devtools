---
title: Guardian Database Schema
description: Overview of the database tables used by Stripe Guardian.
---

# Guardian Schema

This document describes the database schema for the Stripe Guardian module.

## Tables

### connected_accounts

Stores information about connected Stripe merchant accounts.

| Column            | Type        | Description                                     |
| ----------------- | ----------- | ----------------------------------------------- |
| id                | uuid        | Primary key                                     |
| stripe_account_id | text        | Stripe Connect account ID (e.g., "acct_123...") |
| business_name     | text        | Display name of the business                    |
| status            | text        | Account status (active, disabled, etc.)         |
| metadata          | jsonb       | Additional account data                         |
| created_at        | timestamptz | Timestamp when record was created               |

### payout_events

Stores raw webhook events related to payouts.

| Column            | Type        | Description                                   |
| ----------------- | ----------- | --------------------------------------------- |
| id                | bigint      | Primary key (auto-incrementing)               |
| stripe_event_id   | text        | Stripe event ID (e.g., "evt_123...")          |
| stripe_payout_id  | text        | Associated payout ID (e.g., "po_123...")      |
| stripe_account_id | text        | Associated Stripe account ID                  |
| type              | text        | Event type (e.g., "payout.paid")              |
| amount            | bigint      | Payout amount in cents/smallest currency unit |
| currency          | text        | Three-letter currency code (e.g., "usd")      |
| event_data        | jsonb       | Full event payload from Stripe                |
| created_at        | timestamptz | Timestamp when record was created             |

**Indexes:**

- `payout_events_account_idx` on `stripe_account_id`
- `payout_events_payout_idx` on `stripe_payout_id`

### alerts

Stores alerts generated by the rule engine.

| Column            | Type        | Description                                   |
| ----------------- | ----------- | --------------------------------------------- |
| id                | bigint      | Primary key (auto-incrementing)               |
| alert_type        | text        | Type of alert (e.g., "VELOCITY", "BANK_SWAP") |
| severity          | text        | Alert severity (low, medium, high)            |
| message           | text        | Human-readable alert message                  |
| stripe_payout_id  | text        | Associated payout ID, if relevant             |
| stripe_account_id | text        | Associated Stripe account ID                  |
| event_id          | bigint      | Foreign key to payout_events                  |
| resolved          | boolean     | Whether the alert has been resolved           |
| created_at        | timestamptz | Timestamp when alert was created              |

**Indexes:**

- `alerts_account_idx` on `stripe_account_id`
- `alerts_unresolved_idx` on `resolved` (filtered for unresolved alerts)

## Relationships

- `alerts.event_id` references `payout_events.id` with CASCADE delete

## Example Queries

### Get all unresolved high-severity alerts:

```sql
SELECT * FROM public.alerts
WHERE resolved = false AND severity = 'high'
ORDER BY created_at DESC;
```

### Get recent payout events for a specific account:

```sql
SELECT * FROM public.payout_events
WHERE stripe_account_id = 'acct_test123'
ORDER BY created_at DESC
LIMIT 10;
```

### Get alerts with associated event data:

```sql
SELECT a.*, e.type as event_type, e.event_data
FROM public.alerts a
JOIN public.payout_events e ON a.event_id = e.id
WHERE a.resolved = false
ORDER BY a.created_at DESC;
```
