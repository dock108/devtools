# DOCK108 Home

![CI](https://github.com/dock108/devtools/actions/workflows/ci.yml/badge.svg)

Umbrella site for DOCK108 developer tools.

Built with Next.js (App Router), TypeScript, Tailwind CSS, shadcn/ui, Supabase, and Resend.

## Included Products (v0.1.0)

- **/ (Homepage)**: Overview and links to products.
- **/stripe-guardian**: Stripe Connect payout fraud protection.
  - **/guardian-demo**: Interactive fraud detection demo with scenario selector.
  - **Supported fraud scenarios**:
    - Velocity breach (multiple payouts in short time)
    - Bank account swap before large payout
    - Geographic IP/bank country mismatch
    - Failed charge burst (multiple failures in short time)
    - Sudden payout disable (payouts_enabled changes)
    - High-risk reviews flagged by Stripe
- **/notary-ci**: macOS codesigning & notarization as a service.
- **/crondeck**: Cron job & schedule monitoring.

## Development Environment

- Node.js: v20 (or as specified in `.nvmrc`/`package.json`)
- Supabase Project (for waitlist database)
- Resend Account (for email sending)

## Getting Started

1.  **Environment Variables:**
    Copy `.env.example` to `.env.local` and add your Supabase, Stripe, and Resend keys:

    ```
    # See .env.example for all required variables
    NEXT_PUBLIC_SUPABASE_URL=...
    NEXT_PUBLIC_SUPABASE_ANON_KEY=...
    RESEND_API_KEY=...
    STRIPE_CLIENT_ID=...
    STRIPE_SECRET_KEY=...
    STRIPE_WEBHOOK_SECRET=... # Required for webhook endpoints
    # Additional variables needed for specific features
    ```

    > **Note:** Environment files are not in repo; create them locally using values printed by setup scripts.

2.  **Install Dependencies:**

    ```bash
    npm install
    ```

3.  **Run Development Server:**

    ```bash
    npm run dev
    ```

    Open [http://localhost:3000](http://localhost:3000) in your browser.

4.  **For Stripe Guardian Development:**
    If you're working with Stripe Guardian features, see [Guardian Local Development](./docs/guardian/local-dev.md) for detailed instructions on setting up Stripe Connect OAuth and webhooks locally.

## Database Setup

If you're working with the Stripe Guardian component, you'll need to set up the database schema:

1. **Start Supabase Local Development:**

   ```bash
   pnpm supabase start
   ```

2. **Apply Migrations:**
   ```bash
   supabase db reset
   ```

This will create all required tables and seed initial test data, including the new `settings` table and `alerts_notify_tg` trigger for notifications.

### Data Model

Guardian uses the following core tables:

- `connected_accounts`: Stripe Connect accounts linked to the platform. Includes `rule_set_id` to link to custom rule thresholds.
- `rule_sets`: Stores named rule configurations (JSON) including the `default` set.
- `event_buffer`: Raw Stripe webhook events awaiting processing
- `processed_events`: Idempotency tracking table to ensure each event is processed exactly once
- `alerts`: Fraud alerts generated by rule evaluations
- `settings`: Global (or potentially per-account) settings for notifications (tier, email, Slack).
- `alert_channels`: Notification and auto-pause settings per account

> **Note:** Environment files (.env.local) are git-ignored; copy values printed by setup scripts such as `scripts/apply_event_buffer_migration.py` which will suggest environment variables like `EVENT_BUFFER_TTL_DAYS`.

## Guardian Configuration

### Rule Thresholds

Fraud detection rule thresholds (e.g., velocity limits, minimum payout amounts) can be customized per Stripe account.

1.  Create a new rule set configuration (or use the `default`) in the `public.rule_sets` table. You can use the helper script:
    ```bash
    # Requires a JSON file with the config structure
    npx ts-node scripts/create_rule_set.ts -n <rule_set_name> -f <path_to_config.json>
    # Note the returned Rule Set ID (UUID)
    ```
2.  Update the target account in `public.connected_accounts`, setting its `rule_set_id` to the UUID of the desired rule set.

See `docs/guardian/rules.md` for more details.

### Alert Notifications

Guardian can send email and Slack notifications when new alerts are generated.

See [docs/guardian/notifications.md](./docs/guardian/notifications.md) for setup instructions, required environment variables, and configuration details.

## Available Scripts

- `npm run dev`: Starts the development server.
- `npm run lint`: Lints the codebase using Next.js ESLint config.
- `npm run format`: Formats code using Prettier.
- `npm run build`: Creates an optimized production build.
- `npm start`: Starts the production server (requires `npm run build` first).

## Testing

### Unit Tests

Unit tests use Jest and can be run with `npm test`.

### End-to-End Tests

We use Playwright for lightweight smoke tests that verify our key marketing pages load correctly:

```bash
# Run in headless mode
npm run test:e2e

# Run in debug mode with browser UI
PWDEBUG=1 npm run test:e2e
```

See `/tests/e2e/README.md` for more details on e2e tests.

### Full Stack E2E Test (GitHub Actions)

A comprehensive end-to-end test harness runs in GitHub Actions (`.github/workflows/supabase-e2e.yml`) on pushes/PRs to `main`:

1.  **Setup**: Checks out code, installs dependencies.
2.  **Supabase**: Starts a local Supabase instance using the official CLI action and applies all migrations.
3.  **Seed**: Seeds a dedicated test user and connected account (`ci-tester@dock108.ai`, `acct_ci123`).
4.  **App Start**: Starts the Next.js application locally.
5.  **Stripe Replay**: Uses the Stripe CLI to replay a fixture file (`test/fixtures/full_day.jsonl`) containing ~50 realistic events against the local application's webhook endpoint.
6.  **Processing Wait**: Waits for the backend (Reactor, etc.) to process the events (currently uses a fixed delay, ideally would check metrics).
7.  **Cypress Test**: Runs the `cypress/e2e/full_stack.cy.ts` spec:
    - Verifies the real-time alert badge appears in the header.
    - Navigates to the alerts dashboard by clicking the badge.
    - Checks that expected alert types (from the fixture) are present in the alerts table.
    - Confirms the alert badge clears after navigation (marking as read).
    - Uses Cypress tasks to verify that alerts were marked as read in the database.
8.  **Artifacts**: Uploads Cypress screenshots (on failure) and Stripe CLI logs for debugging.

This workflow acts as a critical regression gate before deployments.

**Running Locally:**

While the full flow relies on GitHub Actions secrets and setup, you can simulate parts locally:

1.  Ensure Supabase local dev is running (`supabase start`).
2.  Ensure migrations are applied (`supabase db reset`).
3.  Manually run the seed SQL for the CI user (see G-18 issue or workflow file).
4.  Ensure your `.env.local` has Supabase/Stripe keys and `STRIPE_WEBHOOK_SECRET=whsec_test_fixture_secret` (matching the workflow).
5.  Start the app: `npm run dev`.
6.  In another terminal, run the fixture replay: `stripe listen --forward-to http://localhost:3000/api/stripe/webhook --events-from-file test/fixtures/full_day.jsonl`.
7.  Run the specific Cypress spec: `npx cypress run --spec cypress/e2e/full_stack.cy.ts` (ensure `CYPRESS_BASE_URL` is set or configured).

## Deployment

This project is intended for deployment on Vercel. Ensure environment variables for Supabase and Resend are set in the Vercel project settings.

## ðŸš€ Deploying to Vercel

1. Duplicate `.env.example` â†’ `.env` and fill in the required secrets.
2. Push the secrets to Vercel:

```bash
pnpm vercel:env
```

3. Deploy the app:

```bash
vercel --prod
```

The script will fail fast if any required secret is missing locally.

Supabase Edge Functions (`send-welcome-email`, `weekly-digest`) need to be deployed separately using the Supabase CLI and database triggers/cron schedules configured in the Supabase dashboard.

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.

## Contributing

Please see [CONTRIBUTING.md](docs/CONTRIBUTING.md) for guidelines on how to get started, branch naming, commit formatting, and the PR process.

**Contributing to Accuracy**: Help improve Guardian by providing feedback on alerts. See [Alert Feedback documentation](docs/guardian/feedback.md).

## Interactive Demos

### Guardian Demo

The Stripe Guardian demo (/guardian-demo) showcases fraud detection in action:

- **Scenario Selection**: Choose from predefined fraud scenarios (velocity breach, bank swap, geo-mismatch) using the dropdown.
- **Persistence**: Your selected scenario is remembered across page reloads via localStorage.
- **Playback Controls**: Restart, loop, and adjust playback speed of scenarios.
- **Real-time Visualization**: Watch events appear in the timeline and see fraud patterns emerge.

To add custom scenarios:

1. Add new JSON files in `public/guardian-demo/scenarios/` following the format in the existing files
2. Update the list of scenarios in `app/guardian-demo/getScenarios.ts`

## Running Lighthouse locally

After building the production bundle, you can run Lighthouse CI against key routes:

```bash
pnpm build && pnpm lh-ci
# Reports are saved in .lighthouseci/index.html
```

## Accessibility

All body text meets WCAG AA contrast (â‰¥4.5:1) against white using slateâ€‘700. Primary navigation uses `data-current` attribute to render a bold, underlined state for the active page without extra JavaScript.

## Alpha Access

During the closed alpha phase, access to the application is restricted to a pre-approved list of email addresses.

To add new testers:

1. Add their email to the `ALPHA_ALLOW_LIST` environment variable in your Vercel settings
2. Multiple emails should be comma-separated:
   ```
   ALPHA_ALLOW_LIST=alice@example.com,bob@company.co,charlie@startup.io
   ```
3. Deploy the changes
4. Share the login URL with your testers

Users not on the allow list will be unable to sign up and will be prompted to contact `beta@dock108.ai` for access.

## Deploy checklist

When applying database migrations:

1. **Apply migrations locally first**

   ```bash
   supabase db push            # run once on your machine
   git add supabase/migrations
   git commit -m "chore(db): new migration"
   git push origin main       # Vercel build will skip db push
   ```

2. **Verify deployment**
   - Confirm Vercel build log no longer mentions "Connecting to remote databaseâ€¦"
   - Verify application functionality to ensure tables and triggers are working

Note: Vercel builds no longer run `supabase db push`. All migrations must be applied locally or through Supabase Studio before pushing code.

## Local development

1.  Install dependencies:
    ```bash
    npm install
    ```
2.  Copy `.env.example` to `.env.local` and fill in your API keys (Supabase, Stripe, Resend):
    ```bash
    cp .env.example .env.local
    ```
3.  Start the development server:
    ```bash
    npm run dev
    ```

### Running tests

```bash
# Run in headless mode
npm run test:e2e

# Run in debug mode with browser UI
PWDEBUG=1 npm run test:e2e
```

See `/tests/e2e/README.md` for more details on e2e tests.

## User Settings (/settings)

Authenticated users can manage their account settings at the [/settings](/settings) page.

<img width="800" alt="Screenshot of the user settings page showing profile, password, theme, and API key sections." src="https://via.placeholder.com/800x400.png?text=User+Settings+Page+Screenshot+Placeholder">

### Features:

- **Profile**: Update display name and avatar URL.
- **Password**: Change account password (requires meeting complexity rules).
- **Theme**: Choose between Light, Dark, or System default themes.
- **API Keys**: Generate and revoke API keys for programmatic access.
  - **Note**: Generated API keys are shown only **once** upon creation. Store them securely.

### Development Notes:

- **Route**: `app/(auth)/settings/page.tsx` (Server Component)
- **UI Components**: Client components (`ProfileForm`, `PasswordForm`, etc.) located in the same directory.
- **Data**: Fetched server-side via `getProfile` from `lib/supabase/user.ts`.
- **Mutations**: Handled by Server Actions defined in `app/(auth)/settings/actions.ts`, calling helpers in `lib/supabase/user.ts`.
- **Database**: Uses the `public.profiles` table (linked to `auth.users`). RLS policies restrict access to the owner.

## For Stripe Guardian Development

### Setting Up Stripe Webhooks

Guardian processes Stripe events through a centralized webhook system:

1. **Run the webhook setup script:**

   ```bash
   npm run stripe:setup-webhook
   ```

   This script will:

   - Find or create a webhook endpoint in your Stripe account
   - Configure it to listen only to events needed by Guardian
   - Print the necessary environment variables to add to your `.env.local`

2. **Configure Environment:**

   - Add the webhook secret printed by the script to your `.env.local`:

   ```
   STRIPE_WEBHOOK_SECRET=whsec_...
   ```

3. **Verify Configuration:**
   ```bash
   npm run stripe:verify-webhook
   ```
4. **Local Testing:**

   ```bash
   # Start your development server
   npm run dev

   # In a separate terminal, forward events to your local webhook
   stripe listen --forward-to http://localhost:3000/api/stripe/webhook

   # In a third terminal, trigger test events
   stripe trigger charge.failed
   stripe trigger payout.paid
   ```

5. **Event Flow:**
   - Events flow into the `event_buffer` table with the full payload preserved
   - Guardian only accepts events defined in `lib/guardian/stripeEvents.ts`
   - The guardian-reactor processes events asynchronously
   - Failed processing attempts are tracked in `failed_event_dispatch` for retries
   - **Historical Backfill**: Upon initial connection via OAuth callback (`/api/stripe/oauth/callback`), a background job (`guardian-backfill`) is triggered to fetch the last 90 days of relevant events for the account and process them via the `event_buffer` and `guardian-reactor`. See `docs/guardian/backfill.md` for details.

### Validation

Guardian implements strict schema validation for all Stripe events:

1. **Strict Mode (Default):**

   - All incoming webhook payloads are validated against Zod schemas
   - Invalid payloads are rejected with a 400 response and clear error message
   - Ensures the reactor never processes malformed data that could cause errors

2. **Development Mode:**

   - During local development, you can disable strict validation:

   ```
   STRICT_STRIPE_VALIDATION=false
   ```

   - This is useful when working with newer Stripe API versions or testing custom event shapes
   - The environment variable hint is printed to console on startup

3. **Error Handling:**
   - `unsupported_event_type`: Event type not in GUARDIAN_EVENTS list
   - `unsupported_event_shape`: Event payload doesn't match expected schema
   - All validation errors are logged for debugging

For more details on Guardian local development, see [Guardian Local Development](./docs/guardian/local-dev.md).

## Operations

Operational tasks and monitoring for the DOCK108 platform:

- **Guardian Data Retention**: A nightly job (`guardian-retention-job`) automatically scrubs sensitive data from `event_buffer` payloads after 30 days (configurable via `EVENT_BUFFER_TTL_DAYS`) and purges the records entirely after 37 days. See `docs/guardian/retention.md` for details.

## Observability

Guardian provides structured logging and Prometheus metrics for monitoring and debugging.

- **Structured Logging**: All components emit JSON logs with consistent fields (`req_id`, `service`, etc.). See `docs/guardian/logging.md` for format details and configuration (`LOG_LEVEL`).
- **Prometheus Metrics**: Key operational metrics are exposed:
  - Next.js Webhook: Scrape `/api/metrics`.
  - Supabase Edge Functions: Use log-based metrics derived from structured logs.
  - Requires `METRICS_AUTH_TOKEN` for the Supabase `/guardian-metrics` endpoint (placeholder).
  - See `docs/guardian/metrics.md` for metric details and scraping instructions.
  - A starter Grafana dashboard is available at `docs/guardian/grafana.json`.
- **Real-time Alert Badge**: The dashboard header includes a notification icon that displays a badge with the count of unread alerts, updated in real-time via Supabase subscriptions. Clicking the icon navigates to the alerts page and marks alerts as read.
